{% extends "base.html" %}
{% block title %}管理员后台 - 学生成绩管理系统{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">管理员后台</h2>
    <ul class="nav nav-tabs" id="adminTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="course-tab" data-bs-toggle="tab" data-bs-target="#course" type="button" role="tab">课程管理</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="teacher-tab" data-bs-toggle="tab" data-bs-target="#teacher" type="button" role="tab">教师管理</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab">学生管理</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="grade-tab" data-bs-toggle="tab" data-bs-target="#grade" type="button" role="tab">成绩查询</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">修改密码</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="adminuser-tab" data-bs-toggle="tab" data-bs-target="#adminuser" type="button" role="tab">管理员管理</button>
        </li>
    </ul>
    <div class="tab-content mt-3" id="adminTabContent">
        <!-- 课程管理 -->
        <div class="tab-pane fade show active" id="course" role="tabpanel">
            <h4>课程管理</h4>
            <form id="addCourseForm" class="row g-3 mb-3">
                <div class="col-md-2">
                    <input type="text" class="form-control" id="cno" placeholder="课程编号" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" id="cname" placeholder="课程名称" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control" id="credit" placeholder="学分" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" id="course_tno" placeholder="授课教师工号" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" id="course_term" placeholder="学期" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">添加课程</button>
                </div>
            </form>
            <div id="courseMsg" class="text-danger mb-2"></div>
            <table class="table table-bordered" id="courseTable">
                <thead><tr><th>课程编号</th><th>课程名称</th><th>学分</th><th>教师工号</th><th>学期</th><th>操作</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- 教师管理 -->
        <div class="tab-pane fade" id="teacher" role="tabpanel">
            <h4>教师管理</h4>
            <form id="addTeacherForm" class="row g-3 mb-3">
                <div class="col-md-2">
                    <input type="text" class="form-control" id="tno" placeholder="工号" required>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="tname" placeholder="姓名" required>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="tdept" placeholder="院系/部门">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">添加教师</button>
                </div>
            </form>
            <div id="teacherMsg" class="text-danger mb-2"></div>
            <table class="table table-bordered" id="teacherTable">
                <thead><tr><th>工号</th><th>姓名</th><th>院系</th><th>操作</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- 学生管理 -->
        <div class="tab-pane fade" id="student" role="tabpanel">
            <h4>学生管理</h4>
            <form id="addStudentForm" class="row g-3 mb-3">
                <div class="col-md-2">
                    <input type="text" class="form-control" id="sno" placeholder="学号" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" id="sname" placeholder="姓名" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" id="smajor" placeholder="专业" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" id="sclass" placeholder="班级">
                </div>
                <div class="col-md-1">
                    <input type="text" class="form-control" id="sex" placeholder="性别">
                </div>
                <div class="col-md-1">
                    <input type="text" class="form-control" id="birthday" placeholder="生日">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">添加学生</button>
                </div>
            </form>
            <div id="studentMsg" class="text-danger mb-2"></div>
            <table class="table table-bordered" id="studentTable">
                <thead><tr><th>学号</th><th>姓名</th><th>专业</th><th>班级</th><th>性别</th><th>生日</th><th>操作</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- 成绩查询 -->
        <div class="tab-pane fade" id="grade" role="tabpanel">
            <h4>学生成绩查询</h4>
            <div class="row mb-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="search_sno" placeholder="学号">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="search_cno" placeholder="课程编号">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="search_term" placeholder="学期">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="searchGradeBtn">查询成绩</button>
                </div>
            </div>
            <table class="table table-bordered" id="gradeTable">
                <thead><tr><th>成绩ID</th><th>学号</th><th>课程编号</th><th>学期</th><th>成绩</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- 修改密码 -->
        <div class="tab-pane fade" id="password" role="tabpanel">
            <h4>修改管理员密码</h4>
            <form id="changePwdForm" class="row g-3 mb-3" style="max-width:400px;">
                <div class="col-12">
                    <input type="password" class="form-control" id="oldPwd" placeholder="原密码" required>
                </div>
                <div class="col-12">
                    <input type="password" class="form-control" id="newPwd" placeholder="新密码" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-warning w-100">修改密码</button>
                </div>
            </form>
            <div id="pwdMsg" class="text-danger"></div>
        </div>
        <!-- 管理员管理 -->
        <div class="tab-pane fade" id="adminuser" role="tabpanel">
            <h4>管理员管理</h4>
            <form id="addAdminForm" class="row g-3 mb-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="ano" placeholder="管理员编号" required>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="aname" placeholder="姓名" required>
                </div>
                <div class="col-md-3">
                    <input type="password" class="form-control" id="apassword" placeholder="初始密码（可选，默认编号/123456）">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">添加管理员</button>
                </div>
            </form>
            <div id="adminMsg" class="text-danger mb-2"></div>
            <table class="table table-bordered" id="adminTable">
                <thead><tr><th>编号</th><th>姓名</th><th>操作</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- 课程编辑模态框 -->
<div class="modal fade" id="editCourseModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="editCourseForm">
      <div class="modal-header"><h5 class="modal-title">编辑课程</h5></div>
      <div class="modal-body">
        <input type="hidden" id="edit_cno">
        <div class="mb-3"><label>课程名称</label><input type="text" class="form-control" id="edit_cname" required></div>
        <div class="mb-3"><label>学分</label><input type="number" class="form-control" id="edit_credit" required></div>
        <div class="mb-3"><label>教师工号</label><input type="text" class="form-control" id="edit_tno" required></div>
        <div class="mb-3"><label>学期</label><input type="text" class="form-control" id="edit_term" required></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary">保存修改</button>
      </div>
    </form>
  </div>
</div>
<!-- 教师编辑模态框 -->
<div class="modal fade" id="editTeacherModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="editTeacherForm">
      <div class="modal-header"><h5 class="modal-title">编辑教师</h5></div>
      <div class="modal-body">
        <input type="hidden" id="edit_tno">
        <div class="mb-3"><label>姓名</label><input type="text" class="form-control" id="edit_tname" required></div>
        <div class="mb-3"><label>院系/部门</label><input type="text" class="form-control" id="edit_tdept"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary">保存修改</button>
      </div>
    </form>
  </div>
</div>
<!-- 学生编辑模态框 -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="editStudentForm">
      <div class="modal-header"><h5 class="modal-title">编辑学生</h5></div>
      <div class="modal-body">
        <input type="hidden" id="edit_sno">
        <div class="mb-3"><label>姓名</label><input type="text" class="form-control" id="edit_sname" required></div>
        <div class="mb-3"><label>专业</label><input type="text" class="form-control" id="edit_smajor" required></div>
        <div class="mb-3"><label>班级</label><input type="text" class="form-control" id="edit_sclass"></div>
        <div class="mb-3"><label>性别</label><input type="text" class="form-control" id="edit_sex"></div>
        <div class="mb-3"><label>生日</label><input type="text" class="form-control" id="edit_birthday"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary">保存修改</button>
      </div>
    </form>
  </div>
</div>

<script>
// 课程管理
function loadCourses() {
    fetch('/api/admin/get_courses').then(r=>r.json()).then(data=>{
        let html = '';
        data.courses.forEach(c=>{
            html += `<tr><td>${c.cno}</td><td>${c.cname}</td><td>${c.credit}</td><td>${c.tno}</td><td>${c.term||''}</td>
            <td>
                <button class='btn btn-sm btn-primary' onclick="showEditCourse('${c.cno}','${c.cname}','${c.credit}','${c.tno}','${c.term||''}')">编辑</button>
                <button class='btn btn-sm btn-danger' onclick="deleteCourse('${c.cno}')">删除</button>
            </td></tr>`;
        });
        document.querySelector('#courseTable tbody').innerHTML = html;
    });
}
function deleteCourse(cno) {
    fetch('/api/admin/delete_course', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cno})})
    .then(r=>r.json()).then(data=>{loadCourses();alert(data.message);});
}
document.getElementById('addCourseForm').onsubmit = function(e){
    e.preventDefault();
    let cno = document.getElementById('cno').value.trim();
    let cname = document.getElementById('cname').value.trim();
    let credit = document.getElementById('credit').value;
    let tno = document.getElementById('course_tno').value.trim();
    let term = document.getElementById('course_term').value.trim();
    fetch('/api/admin/add_course', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({cno, cname, credit, tno, term})
    })
    .then(r => r.json())
    .then(data => {
        if(data.success){
            loadCourses();
            alert('添加成功');
        } else {
            alert('添加失败：' + data.message);
        }
        document.getElementById('courseMsg').innerText = data.message;
    });
};
function showEditCourse(cno, cname, credit, tno, term) {
    document.getElementById('edit_cno').value = cno;
    document.getElementById('edit_cname').value = cname;
    document.getElementById('edit_credit').value = credit;
    document.getElementById('edit_tno').value = tno;
    document.getElementById('edit_term').value = term;
    new bootstrap.Modal(document.getElementById('editCourseModal')).show();
}
document.getElementById('editCourseForm').onsubmit = function(e){
    e.preventDefault();
    let cno = document.getElementById('edit_cno').value;
    let cname = document.getElementById('edit_cname').value;
    let credit = document.getElementById('edit_credit').value;
    let tno = document.getElementById('edit_tno').value;
    let term = document.getElementById('edit_term').value;
    fetch('/api/admin/update_course', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({cno, cname, credit, tno, term})
    })
    .then(r=>r.json())
    .then(data=>{
        loadCourses();
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
    });
};
loadCourses();

// 教师管理
function loadTeachers() {
    fetch('/api/admin/get_teachers').then(r=>r.json()).then(data=>{
        let html = '';
        data.teachers.forEach(t=>{
            html += `<tr><td>${t.tno}</td><td>${t.tname}</td><td>${t.tdept||''}</td>
            <td>
                <button class='btn btn-sm btn-primary' onclick="showEditTeacher('${t.tno}','${t.tname}','${t.tdept||''}')">编辑</button>
                <button class='btn btn-sm btn-danger' onclick="deleteTeacher('${t.tno}')">删除</button>
            </td></tr>`;
        });
        document.querySelector('#teacherTable tbody').innerHTML = html;
    });
}
function deleteTeacher(tno) {
    fetch('/api/admin/delete_teacher', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tno})})
    .then(r=>r.json()).then(data=>{loadTeachers();alert(data.message);});
}
document.getElementById('addTeacherForm').onsubmit = function(e){
    e.preventDefault();
    let tno = document.getElementById('tno').value.trim();
    let tname = document.getElementById('tname').value.trim();
    let tdept = document.getElementById('tdept').value.trim();
    fetch('/api/admin/add_teacher', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tno, tname, tdept})
    })
    .then(r => r.json())
    .then(data => {
        if(data.success){
            loadTeachers();
            alert('添加成功');
        } else {
            alert('添加失败：' + data.message);
        }
        document.getElementById('teacherMsg').innerText = data.message;
    });
};
function showEditTeacher(tno, tname, tdept) {
    document.getElementById('edit_tno').value = tno;
    document.getElementById('edit_tname').value = tname;
    document.getElementById('edit_tdept').value = tdept;
    new bootstrap.Modal(document.getElementById('editTeacherModal')).show();
}
document.getElementById('editTeacherForm').onsubmit = function(e){
    e.preventDefault();
    let tno = document.getElementById('edit_tno').value;
    let tname = document.getElementById('edit_tname').value;
    let tdept = document.getElementById('edit_tdept').value;
    fetch('/api/admin/update_teacher', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({tno, tname, tdept})
    })
    .then(r=>r.json())
    .then(data=>{
        loadTeachers();
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('editTeacherModal')).hide();
    });
};
loadTeachers();

// 学生管理
function loadStudents() {
    fetch('/api/admin/get_students').then(r=>r.json()).then(data=>{
        let html = '';
        data.students.forEach(s=>{
            html += `<tr><td>${s.sno}</td><td>${s.sname}</td><td>${s.smajor}</td><td>${s.sclass||''}</td><td>${s.sex||''}</td><td>${s.birthday||''}</td>
            <td>
                <button class='btn btn-sm btn-primary' onclick="showEditStudent('${s.sno}','${s.sname}','${s.smajor}','${s.sclass||''}','${s.sex||''}','${s.birthday||''}')">编辑</button>
                <button class='btn btn-sm btn-danger' onclick="deleteStudent('${s.sno}')">删除</button>
            </td></tr>`;
        });
        document.querySelector('#studentTable tbody').innerHTML = html;
    });
}
function deleteStudent(sno) {
    fetch('/api/admin/delete_student', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sno})})
    .then(r=>r.json()).then(data=>{loadStudents();alert(data.message);});
}
document.getElementById('addStudentForm').onsubmit = function(e){
    e.preventDefault();
    let sno = document.getElementById('sno').value.trim();
    let sname = document.getElementById('sname').value.trim();
    let smajor = document.getElementById('smajor').value.trim();
    let sclass = document.getElementById('sclass').value.trim();
    let sex = document.getElementById('sex').value.trim();
    let birthday = document.getElementById('birthday').value.trim();
    fetch('/api/admin/add_student', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sno, sname, smajor, sclass, sex, birthday})
    })
    .then(r => r.json())
    .then(data => {
        if(data.success){
            loadStudents();
            alert('添加成功');
        } else {
            alert('添加失败：' + data.message);
        }
        document.getElementById('studentMsg').innerText = data.message;
    });
};
function showEditStudent(sno, sname, smajor, sclass, sex, birthday) {
    document.getElementById('edit_sno').value = sno;
    document.getElementById('edit_sname').value = sname;
    document.getElementById('edit_smajor').value = smajor;
    document.getElementById('edit_sclass').value = sclass;
    document.getElementById('edit_sex').value = sex;
    document.getElementById('edit_birthday').value = birthday;
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
}
document.getElementById('editStudentForm').onsubmit = function(e){
    e.preventDefault();
    let sno = document.getElementById('edit_sno').value;
    let sname = document.getElementById('edit_sname').value;
    let smajor = document.getElementById('edit_smajor').value;
    let sclass = document.getElementById('edit_sclass').value;
    let sex = document.getElementById('edit_sex').value;
    let birthday = document.getElementById('edit_birthday').value;
    fetch('/api/admin/update_student', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({sno, sname, smajor, sclass, sex, birthday})
    })
    .then(r=>r.json())
    .then(data=>{
        loadStudents();
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
    });
};
loadStudents();

// 成绩查询
function loadGrades(sno='',cno='',term='') {
    fetch('/api/admin/get_grades').then(r=>r.json()).then(data=>{
        let html = '';
        data.grades.forEach(g=>{
            if((!sno||g.sno==sno)&&(!cno||g.cno==cno)&&(!term||g.term==term)){
                html += `<tr><td>${g.id}</td><td>${g.sno}</td><td>${g.cno}</td><td>${g.term}</td><td>${g.grade==null?'':g.grade}</td></tr>`;
            }
        });
        document.querySelector('#gradeTable tbody').innerHTML = html;
    });
}
document.getElementById('searchGradeBtn').onclick = function(){
    let sno = document.getElementById('search_sno').value.trim(), cno = search_cno.value.trim(), term = search_term.value.trim();
    loadGrades(sno,cno,term);
    return false;
};
loadGrades();

// 修改密码
changePwdForm.onsubmit = function(e){
    e.preventDefault();
    let old_password = oldPwd.value.trim(), new_password = newPwd.value.trim();
    fetch('/api/admin/change_password', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({old_password,new_password})})
    .then(r=>r.json()).then(data=>{pwdMsg.innerText=data.message;});
};

// 管理员管理
function loadAdmins() {
    fetch('/api/admin/get_admins').then(r=>r.json()).then(data=>{
        let html = '';
        data.admins.forEach(a=>{
            html += `<tr><td>${a.ano}</td><td>${a.aname}</td>
            <td>
                <button class='btn btn-sm btn-primary' onclick="showEditAdmin('${a.ano}','${a.aname}')">编辑</button>
                <button class='btn btn-sm btn-danger' onclick="deleteAdmin('${a.ano}')">删除</button>
            </td></tr>`;
        });
        document.querySelector('#adminTable tbody').innerHTML = html;
    });
}
function deleteAdmin(ano) {
    fetch('/api/admin/delete_admin', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ano})})
    .then(r=>r.json()).then(data=>{
        if(data.success){
            loadAdmins();
            alert('操作成功');
        }else{
            alert(data.message);
        }
        adminMsg.innerText = data.message;
    });
}
document.getElementById('addAdminForm').onsubmit = function(e){
    e.preventDefault();
    let ano = document.getElementById('ano').value.trim(), aname = aname.value.trim(), password = apassword.value.trim();
    let body = {ano, aname};
    if(password) body.password = password;
    fetch('/api/admin/add_admin', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
    .then(r=>r.json()).then(data=>{
        if(data.success){
            loadAdmins();
            alert('操作成功');
        }else{
            alert(data.message);
        }
        adminMsg.innerText = data.message;
    });
};
// 编辑管理员模态框
function showEditAdmin(ano, aname) {
    if(!document.getElementById('editAdminModal')){
        let modalHtml = `
        <div class="modal fade" id="editAdminModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" id="editAdminForm">
              <div class="modal-header"><h5 class="modal-title">编辑管理员</h5></div>
              <div class="modal-body">
                <input type="hidden" id="edit_ano">
                <div class="mb-3"><label>姓名</label><input type="text" class="form-control" id="edit_aname" required></div>
                <div class="mb-3"><label>新密码（可选）</label><input type="password" class="form-control" id="edit_apassword"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-primary">保存修改</button>
              </div>
            </form>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('editAdminForm').onsubmit = function(e){
            e.preventDefault();
            let ano = document.getElementById('edit_ano').value;
            let aname = document.getElementById('edit_aname').value;
            let password = document.getElementById('edit_apassword').value;
            let body = {ano, aname};
            if(password) body.password = password;
            fetch('/api/admin/update_admin', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(body)
            })
            .then(r=>r.json())
            .then(data=>{
                if(data.success){
                    loadAdmins();
                    alert('操作成功');
                }else{
                    alert(data.message);
                }
                bootstrap.Modal.getInstance(document.getElementById('editAdminModal')).hide();
            });
        };
    }
    document.getElementById('edit_ano').value = ano;
    document.getElementById('edit_aname').value = aname;
    document.getElementById('edit_apassword').value = '';
    new bootstrap.Modal(document.getElementById('editAdminModal')).show();
}
loadAdmins();
</script>
{% endblock %} 